//! Build script for generating IBC constants and copying events
//!
//! This generates:
//! 1. `UNIVERSAL_ERROR_ACK` constant to match Solidity's ICS24Host.sol
//! 2. `events.rs` copied from solana_ibc_types for Anchor IDL generation
//!
//! WHY EVENTS ARE COPIED:
//! Anchor's IDL generation only includes events defined with #[event] in the
//! same crate. Events in solana_ibc_types are used at runtime, but anchor-go
//! needs them in the IDL to generate Go types for event parsing.

use sha2::{Digest as _, Sha256};
use std::env;
use std::fs;
use std::path::Path;

const SHA256_SIZE: usize = 32;

fn main() {
    generate_constants();
    generate_events();

    println!("cargo:rerun-if-changed=build.rs");
}

fn generate_constants() {
    let universal_error_ack = compute_sha256(b"UNIVERSAL_ERROR_ACKNOWLEDGEMENT");

    let out_dir = env::var("OUT_DIR").expect("OUT_DIR environment variable not set");
    let dest_path = Path::new(&out_dir).join("constants.rs");

    let content = format!(
        r#"// Auto-generated by build.rs - DO NOT EDIT
// IBC constants that must match cross-chain implementations

/// Universal error acknowledgement as defined in ICS-04
/// This is `sha256("UNIVERSAL_ERROR_ACKNOWLEDGEMENT")`
/// Must match Solidity's `ICS24Host.UNIVERSAL_ERROR_ACK` for cross-chain compatibility
pub const UNIVERSAL_ERROR_ACK: &[u8] = &{universal_error_ack:?};
"#
    );

    fs::write(&dest_path, content).expect("Failed to write constants.rs");
}

fn generate_events() {
    let manifest_dir = env::var("CARGO_MANIFEST_DIR").unwrap();
    let dest_path = Path::new(&manifest_dir).join("src/events.rs");

    // Path to solana_ibc_types events.rs (relative to ics26-router)
    let source_path =
        Path::new(&manifest_dir).join("../../packages/solana-ibc-types/src/events.rs");

    println!("cargo:rerun-if-changed={}", source_path.display());

    let source_content =
        fs::read_to_string(&source_path).expect("Failed to read solana_ibc_types/src/events.rs");

    // Replace the import to use local state re-exports
    let modified_content = source_content.replace(
        "use crate::router::{ClientAccount, Packet};",
        "use crate::state::{ClientAccount, Packet};",
    );

    // Add header explaining this is auto-generated
    let final_content = format!(
        "// AUTO-GENERATED FILE - DO NOT EDIT\n\
         // Generated by build.rs from solana_ibc_types/src/events.rs\n\
         //\n\
         // WHY THIS EXISTS:\n\
         // Anchor's IDL generation only includes events with #[event] defined in the\n\
         // same crate. The actual event emission uses solana_ibc_types versions, but\n\
         // anchor-go needs these definitions in the IDL to generate Go event parsers.\n\
         //\n\
         // See build.rs for the generation logic.\n\n\
         {}",
        modified_content
    );

    fs::write(&dest_path, final_content).expect("Failed to write events.rs");
}

fn compute_sha256(data: &[u8]) -> [u8; SHA256_SIZE] {
    let mut hasher = Sha256::new();
    hasher.update(data);
    let hash_result = hasher.finalize();

    let mut hash = [0u8; SHA256_SIZE];
    hash.copy_from_slice(&hash_result);
    hash
}
