//! Build script to generate EVM function selectors at compile time.
//!
//! This computes keccak256 hashes of Solidity function signatures and
//! generates a Rust file with the 4-byte selectors as constants.

use std::env;
use std::fs::File;
use std::io::Write;
use std::path::Path;

/// EVM function signatures that need selectors computed
const FUNCTION_SIGNATURES: &[(&str, &str)] = &[
    // (constant_name, solidity_signature)
    ("IFT_MINT_SELECTOR", "iftMint(address,uint256)"),
];

fn main() {
    let out_dir = env::var("OUT_DIR").unwrap();
    let dest_path = Path::new(&out_dir).join("evm_selectors.rs");
    let mut f = File::create(&dest_path).unwrap();

    writeln!(f, "// Auto-generated EVM function selectors.").unwrap();
    writeln!(f, "// DO NOT EDIT - generated by build.rs").unwrap();
    writeln!(f).unwrap();

    for (name, signature) in FUNCTION_SIGNATURES {
        let hash = solana_keccak_hasher::hash(signature.as_bytes());
        let selector = &hash.to_bytes()[..4];

        writeln!(
            f,
            "/// Function selector for `{signature}`"
        )
        .unwrap();
        writeln!(
            f,
            "/// keccak256(\"{signature}\")[0..4]",
        )
        .unwrap();
        writeln!(
            f,
            "pub const {name}: [u8; 4] = [0x{:02x}, 0x{:02x}, 0x{:02x}, 0x{:02x}];",
            selector[0], selector[1], selector[2], selector[3]
        )
        .unwrap();
        writeln!(f).unwrap();
    }

    println!("cargo:rerun-if-changed=build.rs");
}
