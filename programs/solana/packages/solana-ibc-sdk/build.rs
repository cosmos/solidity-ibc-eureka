use std::env;
use std::fs;
use std::path::Path;

const PROGRAMS: &[&str] = &[
    "ics26_router",
    "ics07_tendermint",
    "attestation",
    "ift",
    "ics27_gmp",
    "access_manager",
];

fn main() {
    let manifest_dir = env::var("CARGO_MANIFEST_DIR").unwrap();
    let manifest_path = Path::new(&manifest_dir);

    let idl_dir = manifest_path.join("../../target/idl");
    let generated_dir = manifest_path.join("src/generated");

    for program in PROGRAMS {
        let idl_path = idl_dir.join(format!("{program}.json"));
        println!("cargo:rerun-if-changed={}", idl_path.display());
    }
    println!("cargo:rerun-if-changed=build.rs");

    let any_idl_exists = PROGRAMS
        .iter()
        .any(|p| idl_dir.join(format!("{p}.json")).exists());

    if !any_idl_exists {
        if !generated_dir.exists() {
            fs::create_dir_all(&generated_dir).expect("Failed to create src/generated/ directory");
            fs::write(
                generated_dir.join("mod.rs"),
                "// AUTO-GENERATED FILE - DO NOT EDIT\n\
                 // Generated by build.rs â€” run `anchor build` to regenerate\n",
            )
            .expect("Failed to write generated/mod.rs");
        }
        println!(
            "cargo:warning=No IDL files found in target/idl/. \
             Run `anchor build` to generate them."
        );
        return;
    }

    let warnings = solana_ibc_sdk_codegen::generate_all(&idl_dir, &generated_dir, PROGRAMS);
    for w in &warnings {
        println!("cargo:warning={w}");
    }
}
