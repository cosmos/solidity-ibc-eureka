services:
  ibc-attestor-1:
    build:
      context: ../..
      dockerfile: programs/ibc-attestor/Dockerfile
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        ibc_attestor key generate || true
        mkdir -p /tmp/config

        cat > /tmp/config/attestor.toml << EOF
        [server]
        address = "0.0.0.0"
        port = 9000
        log_level = "info"

        [solana]
        url = "https://api.devnet.solana.com"
        account_key = "vines1vzrYbzLMRdu58ou5XTby4qAqVRLmqo36NKPTg"
        EOF

        echo "✅ IBC Attestor 1 starting server on port 9000..."
        ibc_attestor server solana --config /tmp/config/attestor.toml
    ports:
      - "9000:9000"
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/9000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s

  ibc-attestor-2:
    build:
      context: ../..
      dockerfile: programs/ibc-attestor/Dockerfile
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        ibc_attestor key generate || true
        mkdir -p /tmp/config

        cat > /tmp/config/attestor.toml << EOF
        [server]
        address = "0.0.0.0"
        port = 9001
        log_level = "info"

        [solana]
        url = "https://api.devnet.solana.com"
        account_key = "vines1vzrYbzLMRdu58ou5XTby4qAqVRLmqo36NKPTg"
        EOF

        echo "✅ IBC Attestor 2 starting server on port 9001..."
        ibc_attestor server solana --config /tmp/config/attestor.toml
    ports:
      - "9001:9001"
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/9001' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s

  ibc-attestor-3:
    build:
      context: ../..
      dockerfile: programs/ibc-attestor/Dockerfile
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        ibc_attestor key generate || true
        mkdir -p /tmp/config

        cat > /tmp/config/attestor.toml << EOF
        [server]
        address = "0.0.0.0"
        port = 9002
        log_level = "info"

        [solana]
        url = "https://api.devnet.solana.com"
        account_key = "vines1vzrYbzLMRdu58ou5XTby4qAqVRLmqo36NKPTg"
        EOF

        echo "✅ IBC Attestor 3 starting server on port 9002..."
        ibc_attestor server solana --config /tmp/config/attestor.toml
    ports:
      - "9002:9002"
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/9002' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s


  sig-aggregator:
    build:
      context: ../..
      dockerfile: programs/sig-aggregator/Dockerfile
    depends_on:
      ibc-attestor-1:
        condition: service_healthy
      ibc-attestor-2:
        condition: service_healthy
      ibc-attestor-3:
        condition: service_healthy
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        mkdir -p /tmp/config

        cat > /tmp/config/aggregator.toml << EOF
        [server]
        listener_addr = "0.0.0.0:8080"
        log_level = "INFO"

        [attestor]
        attestor_query_timeout_ms = 5000
        quorum_threshold = 2
        attestor_endpoints = [
          "http://ibc-attestor-1:9000",
          "http://ibc-attestor-2:9001",
          "http://ibc-attestor-3:9002"
        ]
        EOF

        echo "✅ Starting aggregator server on port 8080..."
        aggregator server --config /tmp/config/aggregator.toml
    ports:
      - "8080:8080"
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/8080' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 60s
