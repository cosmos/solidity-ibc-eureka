services:
  ibc-attestor-1:
    build:
      args:
        PORT: 9000
      context: ../..
      dockerfile: programs/ibc-attestor/Dockerfile
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        ibc_attestor key generate || true
        ibc_attestor server solana --config /tmp/attestor.toml
    ports:
      - "9000:9000"
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/9000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s

  ibc-attestor-2:
    build:
      args:
        PORT: 9001
      context: ../..
      dockerfile: programs/ibc-attestor/Dockerfile
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        ibc_attestor key generate || true
        ibc_attestor server solana --config /tmp/attestor.toml
    ports:
      - "9001:9001"
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/9001' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s

  ibc-attestor-3:
    build:
      args:
        PORT: 9002
      context: ../..
      dockerfile: programs/ibc-attestor/Dockerfile
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        ibc_attestor key generate || true
        ibc_attestor server solana --config /tmp/attestor.toml
    ports:
      - "9002:9002"
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/9002' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s

  sig-aggregator:
    build:
      context: ../..
      dockerfile: programs/sig-aggregator/Dockerfile
    depends_on:
      ibc-attestor-1:
        condition: service_healthy
      ibc-attestor-2:
        condition: service_healthy
      ibc-attestor-3:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command:
      - aggregator server --config /tmp/aggregator.toml
    ports:
      - "8080:8080"
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/8080' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 60s
