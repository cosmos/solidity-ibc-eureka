name: e2e-lc-combinations
on:
  workflow_dispatch:
    inputs:
      wasm-light-client-tag:
        description: 'Wasm light client release tag'
        type: choice
        required: true
        default: 'local'
        options:
          - local
  pull_request:
    paths:
      - '**.rs'
      - '**.go'
      - '**.toml'
      - '**.lock'
      - '**.mod'
      - '**.sum'
      - '**.sol'
      - '.github/workflows/e2e-lc-combinations.yml'
      - 'bun.lockb'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FOUNDRY_PROFILE: ci
  ETH_TESTNET_TYPE: anvil
  E2E_WASM_LIGHT_CLIENT_TAG: ${{ inputs.wasm-light-client-tag || 'local' }}
  SP1_PROVER: mock
  E2E_PROOF_TYPE: groth16
  SP1_VERSION: "6.0.1"
  IBC_ATTESTOR_IMAGE: ghcr.io/cosmos/ibc-attestor:v0.3.0
  SOLANA_VERSION: "2.3.13"
  ANCHOR_VERSION: "0.32.1"

permissions:
  contents: read
  packages: read

jobs:
  build-e2e-programs:
    runs-on: depot-ubuntu-24.04-4
    steps:
      - uses: actions/checkout@v5
      - name: Build E2E artifacts
        uses: ./.github/actions/e2e-build
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  e2e-lc-combinations:
    needs: build-e2e-programs
    strategy:
      fail-fast: false
      matrix:
        test:
          - Test_TimeoutPacketFromCosmos
          - Test_TimeoutPacketFromEth
          - Test_ICS20TransferERC20TokenfromEthereumToCosmosAndBack
        eth_lc_on_cosmos:
          - dummy
          - attestor-wasm
          - attestor-native
        cosmos_lc_on_eth:
          - sp1
          - attestor
    name: ${{ matrix.test }}/eth=${{ matrix.eth_lc_on_cosmos }}/cosmos=${{ matrix.cosmos_lc_on_eth }}
    env:
      ETH_LC_ON_COSMOS: ${{ matrix.eth_lc_on_cosmos }}
      COSMOS_LC_ON_ETH: ${{ matrix.cosmos_lc_on_eth }}

    runs-on: depot-ubuntu-24.04-4
    steps:
      - uses: actions/checkout@v5
      - name: Set up E2E environment
        uses: ./.github/actions/e2e-setup
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Tests
        env:
          NETWORK_PRIVATE_KEY: ${{ secrets.SP1_PRIVATE_KEY }}
        run: |
          cd e2e/interchaintestv8
          go test -v -mod=readonly . -run "^TestWithIbcEurekaTestSuite$/${{ matrix.test }}$" -timeout 60m
