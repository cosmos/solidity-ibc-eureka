name: e2e-setup

inputs:
  github_token:
    description: A Github PAT
    required: true

runs:
  using: composite
  steps:
    - name: Set up foundry tooling
      uses: ./.github/actions/foundry-setup

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.25
        check-latest: true
        cache-dependency-path: e2e/interchaintestv8/go.sum

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: e2e-build-artifacts
        path: e2e-artifacts/

    - name: Cache Solana
      id: cache-solana
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/solana/
          ~/.local/share/solana/
          ~/.cargo/bin/anchor
          ./programs/solana/target/deploy/
          ./programs/solana/target/sbpf-solana-solana/
        key: ${{ runner.os }}-solana-${{ env.SOLANA_VERSION }}-${{ env.ANCHOR_VERSION }}-${{ hashFiles('programs/solana/**') }}

    - name: Install just
      uses: extractions/setup-just@v2

    - name: Install artifacts
      shell: bash
      run: |
        # Install binaries
        chmod +x e2e-artifacts/bin/*
        mkdir -p ~/.cargo/bin
        cp e2e-artifacts/bin/* ~/.cargo/bin/
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

        # Install SP1 programs
        mkdir -p programs/sp1-programs/target/elf-compilation/riscv32im-succinct-zkvm-elf/release/
        cp -r e2e-artifacts/sp1-programs/* programs/sp1-programs/target/elf-compilation/riscv32im-succinct-zkvm-elf/release/

        # Install Solana programs
        mkdir -p programs/solana/target/deploy/
        cp -r e2e-artifacts/solana-programs/* programs/solana/target/deploy/

    - name: Setup Kurtosis
      if: contains(fromJSON('["pos", "optimism", "arbitrum", "cosmos"]'), env.ETH_TESTNET_TYPE)
      shell: bash
      run: |
        echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | sudo tee /etc/apt/sources.list.d/kurtosis.list
        sudo apt update
        sudo apt install kurtosis-cli=1.11.2 # Must match the kurtosis library version we use in the e2e tests
        kurtosis engine start
        kurtosis analytics disable
        echo "$(dirname $(which kurtosis))" >> $GITHUB_PATH

    - name: Setup Solana
      uses: solana-developers/github-actions/setup-all@v0.2.5
      with:
        solana_version: ${{ env.SOLANA_VERSION }}

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github_token }}

    - name: Install just
      if: steps.cache-solana.outputs.cache-hit != 'true'
      uses: extractions/setup-just@v2

    - name: Build Solana Programs
      if: steps.cache-solana.outputs.cache-hit != 'true'

    - name: Pull attestor Docker image
      shell: bash
      run: docker pull ghcr.io/cosmos/ibc-attestor:v0.2.0
